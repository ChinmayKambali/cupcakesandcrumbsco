<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cupcakes & Crumbs Co â€“ Admin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 40px 60px;
      font-family: "Gochi Hand", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #ffe1ec 0%, #ffd3e0 40%, #f9c1d0 100%);
      color: #2b1b1f;
      box-sizing: border-box;
    }

    .page {
      border: 2px solid #b98ad0;
      padding: 30px 40px 40px;
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255, 250, 252, 0.7);
    }

    h1 {
      margin: 0 0 24px;
      font-size: 32px;
    }

    h2 {
      margin: 0 0 16px;
      font-size: 26px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      font-size: 18px;
    }

    .top-bar label {
      margin-right: 6px;
    }

    .top-bar input {
      padding: 2px 6px;
      border: 1px solid #444;
      background: transparent;
      font-family: inherit;
      font-size: 16px;
    }

    .load-btn {
      padding: 4px 10px;
      border: 1px solid #444;
      background: transparent;
      cursor: pointer;
      font-family: inherit;
      font-size: 16px;
    }

    .load-btn:hover {
      background: #ffd8e6;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 40px;
      margin-top: 10px;
    }

    /* Orders section */

    #orders-container {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }

    .order-card {
      border: 2px solid #2b1b1f;
      padding: 10px 14px 12px;
      font-size: 16px;
      background: rgba(255, 248, 252, 0.9);
    }

    .order-card h3 {
      margin: 0 0 6px;
      font-size: 18px;
    }

    .order-line {
      margin: 0;
    }

    .order-items {
      margin: 6px 0 6px 14px;
      padding-left: 0;
    }

    .order-items li {
      margin-bottom: 2px;
    }

    .complete-btn {
      margin-top: 6px;
      padding: 2px 10px;
      border: 1px solid #444;
      background: transparent;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }

    .complete-btn:hover {
      background: #ffd8e6;
    }

    /* Analytics section */

    .analytics-summary {
      font-size: 18px;
      margin-bottom: 18px;
    }

    .analytics-summary p {
      margin: 0 0 4px;
    }

    .analytics-blocks {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .analytics-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 16px;
    }

    .analytics-table th,
    .analytics-table td {
      border: 1px solid #2b1b1f;
      padding: 4px 8px;
      text-align: left;
    }

    .analytics-table th {
      text-align: center;
    }

    .section-title {
      margin-bottom: 6px;
      font-size: 20px;
    }

    #admin-message {
      margin-top: 10px;
      min-height: 18px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Admin - Orders</h1>

    <div class="top-bar">
      <div>
        <label for="admin-key">Admin key:</label>
        <input type="password" id="admin-key" />
      </div>

      <div>
        <label for="from-date">From: </label>
        <input type="date" id="from-date" />
      </div>

      <div>
        <label for="to-date">To: </label>
        <input type="date" id="to-date" />
      </div>

      <button class="load-btn" onclick="loadAll()">Load Orders</button>
    </div>

    <div id="admin-message"></div>

    <div class="layout">
      <!-- Orders column -->
      <section>
        <h2>Orders</h2>
        <div id="orders-container"></div>
      </section>

      <!-- Analytics column -->
      <section>
        <h2>Analytics</h2>

        <div class="analytics-summary" id="analytics-summary">
          <p>Total Orders: -</p>
          <p>Total Revenue: -</p>
        </div>

        <div class="analytics-blocks">
          <div>
            <div class="section-title">Orders per Week</div>
            <table class="analytics-table" id="weekly-table">
              <thead>
                <tr>
                  <th>Week Starting</th>
                  <th>Orders</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div>
            <div class="section-title">Top Products</div>
            <table class="analytics-table" id="products-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000"; // change to Render URL after deploy

    function setMessage(text) {
      document.getElementById("admin-message").textContent = text || "";
    }

    function getAuthHeaders() {
      const key = document.getElementById("admin-key").value;
      return { "X-Admin-Key": key };
    }

    async function loadOrders() {
      setMessage("");
      const params = new URLSearchParams();
      const fromDate = document.getElementById("from-date").value;
      const toDate = document.getElementById("to-date").value;
      if (fromDate) params.append("from_date", fromDate);
      if (toDate) params.append("to_date", toDate);

      const url = `${API_BASE}/api/admin/orders`;
      const resp = await fetch(params.toString() ? `${url}?${params}` : url, {
        headers: getAuthHeaders(),
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        setMessage(data.detail || "Error loading orders");
        document.getElementById("orders-container").innerHTML = "";
        return;
      }

      const data = await resp.json();
      renderOrders(data.orders || []);
    }

    function renderOrders(orders) {
      const container = document.getElementById("orders-container");
      container.innerHTML = "";

      if (!orders.length) {
        container.textContent = "No pending orders.";
        return;
      }

      orders.forEach((order) => {
        const card = document.createElement("div");
        card.className = "order-card";

        const title = document.createElement("h3");
        title.textContent = `Order #${order.order_id}`;
        card.appendChild(title);

        const nameLine = document.createElement("p");
        nameLine.className = "order-line";
        nameLine.textContent = `${order.customer_name} (${order.phone})`;
        card.appendChild(nameLine);

        const addrLine = document.createElement("p");
        addrLine.className = "order-line";
        addrLine.textContent = order.address;
        card.appendChild(addrLine);

        const dateLine = document.createElement("p");
        dateLine.className = "order-line";
        dateLine.textContent = order.created_at;
        card.appendChild(dateLine);

        if (order.note) {
          const noteLine = document.createElement("p");
          noteLine.className = "order-line";
          noteLine.textContent = `Note: ${order.note}`;
          card.appendChild(noteLine);
        }

        const ul = document.createElement("ul");
        ul.className = "order-items";
        order.items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = `${item.product_name} x${item.quantity} - Rs.${item.line_total}/-`;
          ul.appendChild(li);
        });
        card.appendChild(ul);

        const btn = document.createElement("button");
        btn.className = "complete-btn";
        btn.textContent = "Mark as completed";
        btn.onclick = () => completeOrder(order.order_id);
        card.appendChild(btn);

        container.appendChild(card);
      });
    }

    async function completeOrder(orderId) {
      setMessage("");
      const resp = await fetch(
        `${API_BASE}/api/admin/orders/${orderId}/complete`,
        {
          method: "POST",
          headers: getAuthHeaders(),
        }
      );

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        setMessage(data.detail || data.error || "Error completing order");
        return;
      }

      setMessage(data.message || "Order completed");
      await loadOrders();
      await loadAnalytics();
    }

    async function loadAnalytics() {
      const params = new URLSearchParams();
      const fromDate = document.getElementById("from-date").value;
      const toDate = document.getElementById("to-date").value;
      if (fromDate) params.append("from_date", fromDate);
      if (toDate) params.append("to_date", toDate);

      const url = `${API_BASE}/api/admin/analytics`;
      const resp = await fetch(params.toString() ? `${url}?${params}` : url, {
        headers: getAuthHeaders(),
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        setMessage(data.detail || "Error loading analytics");
        return;
      }

      const data = await resp.json();
      renderAnalytics(data);
    }

    function renderAnalytics(data) {
      const summary = data.summary || { total_orders: 0, total_revenue: 0 };
      const summaryDiv = document.getElementById("analytics-summary");
      summaryDiv.innerHTML = `
        <p>Total Orders: ${summary.total_orders}</p>
        <p>Total Revenue: Rs.${summary.total_revenue}/-</p>
      `;

      const weeklyBody = document
        .getElementById("weekly-table")
        .querySelector("tbody");
      weeklyBody.innerHTML = "";
      (data.orders_per_week || []).forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.week_start}</td>
          <td style="text-align:center;">${row.order_count}</td>
          <td>Rs.${row.revenue}/-</td>
        `;
        weeklyBody.appendChild(tr);
      });

      const productsBody = document
        .getElementById("products-table")
        .querySelector("tbody");
      productsBody.innerHTML = "";
      (data.top_products || []).forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.product_name} ${row.flavour ? "(" + row.flavour + ")" : ""}</td>
          <td style="text-align:center;">${row.total_quantity}</td>
          <td>Rs.${row.total_revenue}/-</td>
        `;
        productsBody.appendChild(tr);
      });
    }

    async function loadAll() {
      await loadOrders();
      await loadAnalytics();
    }
  </script>
</body>
</html>
